---
title: 06.1 Hystrix服务熔断
date: 2019-09-02 19:04:47
categories: SpringCloud
tags:
- SpringCloud
- Spring
---

> 熔断机制是应对雪崩效应的一种微服务链路保护机制。

<!--more-->

当扇出链路的某个微服务不可用或者响应时间太长时，会进行服务的降级， 进而熔断该节点微服务的调用，快速返回"错误"的响应信息。 当检测到该节点微服务调用响应正常后恢复调用链路。在SpringCloud框架里熔断机制通过Hystrix实现。Hystrix会监控微服务间调用的状况，当失败的调用到一定阈值，缺省是5秒内20次调用失败就会启动熔断机制。熔断机制的注解是@HystrixCommand。 

## 1. 创建工程
参考microservicecloud-provider-dept-8001, 新建microservicecloud-provider-dept-hystrix-8001

## 2. pom.xml文件
与provider-dept-8001相比,pom文件中增加了Hystrix配置
```xml
<!--hystrix-->
<dependency>
   <groupId>org.springframework.cloud</groupId>
   <artifactId>spring-cloud-starter-hystrix</artifactId>
</dependency>
```

## 3. yml文件
与provider-dept-8001相比,yml中修改了服务注册进入eureka的实例名称

```yaml
instance-id: microservicecloud-dept8001-hystrix
```

## 4. 修改DeptController
在精简原来代码的基础上,增加了@HystrixCommand注解,一旦调用服务方法失败并抛出了错误信息后，会自动调用@HystrixCommand标注好的fallbackMethod调用类中的指定方法.

```java
@RestController
public class DeptController {
    @Autowired
    private DeptService service;
    @RequestMapping(value = "/dept/get/{id}", method = RequestMethod.GET)
    @HystrixCommand(fallbackMethod = "processHystrix_Get")
    public Dept get(@PathVariable("id") Long id) {
        Dept dept = service.get(id);
        if (dept == null) {
            throw new RuntimeException("该ID:" + id + "没有对应的信息");
        }
        return dept;
    }
    public Dept processHystrix_Get(@PathVariable("id") Long id) {
        return new Dept().setDeptno(id)
                .setDname("该ID:" + id + "没有对应的信息,null--@HystrixCommand")
                .setDb_source("no this database in MySQL");
    }
}
```

## 5. 主启动类修改
```java
@SpringBootApplication
// 本服务启动后会自动注册进 eureka 服务中
@EnableEurekaClient
// 服务发现
@EnableDiscoveryClient
// 对hystrix熔断机制的支持
@EnableCircuitBreaker
public class ProviderDeptHystrix8001Application {
   public static void main(String[] args) {
      SpringApplication.run(ProviderDeptHystrix8001Application.class, args);
   }
}
```

## 6. 验证
首先启动Eureka集群,然后启动provider-dept-hystrix-8001,等待服务注册

![](https://raw.githubusercontent.com/lujiahao0708/PicRepo/master/blogPic/SpringCloud/%E5%B0%9A%E7%A1%85%E8%B0%B7-SpringCloud%E6%95%99%E7%A8%8B/06.1%20Hystrix%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD/1.png)

最后启动consumer-dept-8001,并访问验证
```jshelllanguage
curl http://localhost/consumer/dept/get/1
{
    "deptno": 1,
    "dname": "开发部",
    "db_source": "cloudDB01"
}
curl http://localhost/consumer/dept/get/112
{
    "deptno": 112,
    "dname": "该ID:112没有对应的信息,null--@HystrixCommand",
    "db_source": "no this database in MySQL"
}
```


## 资源获取
公众号回复 : Hystrix服务熔断 获取本节代码

公众号回复 : SpringCloud思维导图

## Tips
欢迎收藏和转发，感谢你的支持！(๑•̀ㅂ•́)و✧ 

欢迎关注我的公众号：庄里程序猿，读书笔记教程资源第一时间获得！

![](https://github.com/lujiahao0708/PicRepo/raw/master/公众号二维码.jpg)
